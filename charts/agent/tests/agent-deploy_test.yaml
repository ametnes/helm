suite: Agent Deployment
templates:
  - agent-deploy.yaml
tests:
  - it: should set image tag
    set:
      agent:
        clientCertSecret: tls-secret
        image:
          tag: latest
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: RELEASE-NAME-cloud-agent
      - equal:
          path: spec.template.spec.containers[0].image
          value: ametnes/cloud-agent:latest
      - equal:
          path: spec.template.spec.volumes[1].configMap.name
          value: RELEASE-NAME-cloud-agent

  - it: should set config
    set:
      agent:
        clientCertSecret: tls-secret
        config:
          name: agent-config
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].configMap.name
          value: agent-config


  - it: should not set client cert secret
    set:
      agent:
        clientCertsSecret: ~
    asserts:
      - notContains:
          path: spec.template.spec.volumes
          content:
            - name: tls

  - it: should set config
    set:
      agent:
        imagePullSecrets: null
    asserts:
      - isNull:
          path: spec.template.spec.imagePullSecrets

